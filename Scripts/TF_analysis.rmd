```{r LIBRARIES, echo=FALSE, message=FALSE, warning=FALSE}
# nolint start
library(pacman)
p_load(GenomicRanges, ggplot2, rtracklayer, dplyr, plyranges, ChIPseeker,
TxDb.Mmusculus.UCSC.mm10.knownGene, TxDb.Hsapiens.UCSC.hg38.knownGene,
BSgenome.Mmusculus.UCSC.mm10, BSgenome.Hsapiens.UCSC.hg38, org.Mm.eg.db,
org.Hs.eg.db, annotables, rBLAST, rentrez, clusterProfiler, ensembldb,
EnsDb.Mmusculus.v79, deepredeff)
# nolint end
```

```{r PATH_DECLARATION, echo=FALSE, message=FALSE, warning=FALSE}
# nolint start
PROJECT     <- paste0("/home/daniele/Desktop/IV_course/II_semester/TF_analysis/")
BIGBEDS     <- paste0(PROJECT, "Input/BigBed/")
BEDS        <- paste0(PROJECT, "Input/BED/")
MMUSCULUS   <- paste0(BEDS, "Mouse/")
HSAPIENS    <- paste0(BEDS, "Human/")
INTER_FILES <- paste0(PROJECT, "Intermediate_data/")
SCRIPTS     <- paste0(PROJECT, "Scripts/")
RESULTS     <- paste0(INTER_FILES, "Generated_files/")
FASTAS      <- paste0(INTER_FILES, "FASTA/")
FIGURES     <- paste0(PROJECT, "Figures/")
SAMPLES     <- read.csv(file = paste0(INTER_FILES, "sample_key.csv"))
DATABASES   <- paste0(PROJECT, "Databases/")
# nolint end
```

```{r FUNCTION_SOURCING, echo=FALSE, message=FALSE, warning=FALSE}
source(paste0(SCRIPTS, "functions.R"))
```

```{r OBJECT_DECLARATION, echo=FALSE, message=FALSE, warning=FALSE}
txdb_mm <- TxDb.Mmusculus.UCSC.mm10.knownGene
txdb_hs <- TxDb.Hsapiens.UCSC.hg38.knownGene

orgdb_mm <- "org.Mm.eg.db"
orgdb_hs <- "org.Hs.eg.db"

orgdbmm_obj <- org.Mm.eg.db
orgdbhs_obj <- org.Hs.eg.db

edb <- EnsDb.Mmusculus.v79
```


```{r BIGBED_READING, echo=FALSE, message=FALSE, warning=FALSE}
# nolint start
# Listing sample BigBed files for each analyzed organism:
bbfiles_mm <- list.files(path = MMUSCULUS, "*bed")
bbfiles_hg <- list.files(path = HSAPIENS, "*bed")

# Making a granges list for each analyzed organism:
grl_mm <- GRangesList()
grl_hg <- GRangesList()

chr_abr <- c(paste0("chr", 1:19), "chrX", "chrY")
len_mm <- length(bbfiles_mm)    # Length of samples for Mus musculus
len_hg <- length(bbfiles_hg)    # Length of samples for Homo sapiens

data_mm <- list()
for(rows in 1:len_mm) {
    data_mm[[rows]] <- read.table(file = paste0(MMUSCULUS, bbfiles_mm[rows]))
    colnames(data_mm[[rows]]) <-
        c("seqnames", "start", "end", "name", "abs_summit", "pileup",
          "p_value", "fold_enrichment", "q_value", "ID")

    grl_mm[[rows]] <- makeGRangesFromDataFrame(data_mm[[rows]],
                                               keep.extra.columns = TRUE)
}

data_hs <- list()
for(rows in 1:len_hg) {
    data_hs[[rows]] <- read.table(file = paste0(HSAPIENS, bbfiles_hg[rows]))
    colnames(data_hs[[rows]]) <-
        c("seqnames", "start", "end", "name", "abs_summit", "pileup",
          "p_value", "fold_enrichment", "q_value", "ID")

    grl_hg[[rows]] <- makeGRangesFromDataFrame(data_hs[[rows]],
                                               keep.extra.columns = TRUE)
}
# nolint end
```

```{r PWM_READING, echo=FALSE, message=FALSE, warning=FALSE}
# nolint start
# Making a list of analyzed TF PWM matrices from different organisms:
pwm <- get_PWM("TBX5_MOUSE.H11MO.0.D.pwm")
# nolint end
```

```{r MM_PEAK_ANNOTATION, echo=FALSE, message=FALSE, warning=FALSE, output=FALSE}
# nolint start
mm_annot_peaks <- annotate_peaks(grl_mm, grcm38, txdb_mm, orgdb_mm)

write.table(mm_annot_peaks, file = paste0(RESULTS, "/mm_annotated_peaks.txt"),
            sep = "\t", quote = FALSE, row.names = FALSE)
# nolint end
```

```{r HS_PEAK_ANNOTATION, echo=FALSE, message=FALSE, warning=FALSE, output=FALSE}
hg_annot_peaks <- annotate_peaks(grl_hg, grch38, txdb_hs, orgdb_hs)

write.table(hg_annot_peaks, file = paste0(RESULTS, "/hg_annotated_peaks.txt"),
            sep = "\t", quote = FALSE, row.names = FALSE)
# nolint end
```

```{r NUCLEOTIDE_TO_AMINOACIDS, echo=FALSE, message=FALSE, warning=FALSE, output=FALSE}
# nolint start
mmgene_ranges <- genes(txdb_mm)

# Adding 'gene_symbol' column to gene_ranges GRange:
mmgene_ranges$gene_symbol <- mapIds(orgdbmm_obj, keys = mmgene_ranges$gene_id,
                                    column = "SYMBOL", keytype = "ENTREZID")

mm_genes <- GRangesList()

for (sample in seq_along(mm_annot_peaks)) {
    selected_genes <-
        tolower(unique(mm_annot_peaks[[sample]]$gene_symbol)) %in%
        tolower(mmgene_ranges$gene_symbol)

    mm_genes[[sample]] <- mmgene_ranges[selected_genes]
}

# Čia išgaunamos nukleotidų sekos konkretiems genams:
# gene_sequences <- getSeq(BSgenome.Mmusculus.UCSC.mm10, mm_genes[[1]])

all_proteins <- character()

for (gene_name in 1:length(unique(mm_genes[[1]]$gene_symbol))) {
    gene <- mm_genes[[1]]$gene_symbol[[gene_name]]

    if (is.na(gene)) {
        next
    } else {
        proteins <- proteins(edb, filter = GeneNameFilter(gene),
                     return.type = "AAStringSet")

        if (length(proteins) == 0) {
            next
        } else {
            print(paste("Getting sequence for", gene, "..."))
            proteins_df <- aas_to_df(proteins)
            proteins_df$name <- gene

            for (s in 1:length(proteins_df$seq)) {
                all_proteins <- append(all_proteins, proteins[s])
            }
            proteins_df <- c()
        }
    }
}

writeXStringSet(AAStringSet(all_proteins),
                filepath = paste0(RESULTS, "Extracted_protein_sequences.fasta"),
                format = "fasta")

# nolint end
```

Su Blast surandame Homo sapiens genus, kurie yra panašūs į Mus musculus
genus (sekų identiškumas = 60).

Sudarome lentelę, kurioje nurodytas Mus musculus genas ir jo ID bei jo
Blast atitikmuo - genas ir jo ID.


```{r BLAST_SEARCH, echo=FALSE, message=FALSE, warning=FALSE}
# nolint start
# Loading downloaded Homo sapiens protein database:
human_db <-
    blast(db = paste0(DATABASES,
          "Homo_sapiens_protein/GCF_000001405.38_GRCh38.p12_protein.fna"),
          type = "blastp")

# Performing blastp search using defined Homo sapiens protein database and
# 'AAStringSet' object that contains protein sequences of annotated genes:
predictions <-
    predict(human_db, all_proteins,
            BLAST_args = "-num_threads 10",
            custom_format = "qseqid sseqid qacc saqq length qcovs evalue")

# Saving blastp result into a file so that it can be used for further analysis:
# FIND BETTER WAY TO SAVE THE RESULT!
sink(paste0(PROJECT, "predictions_protein.txt"))
print(predictions)
sink()
# nolint end
```

```{r ID_MAPPINGS, echo=FALSE, message=FALSE, warning=FALSE}
# nolint start
# Reading a file that stores blastp result:
predictions <- read.table(paste0(PROJECT, "predictions_p.txt"))
predictions <- predictions[predictions$`Perc.Ident` > 50, ] #50, 60, 70

grouped_predictions <-
    predictions %>%
    group_by(QueryID) %>%
    dplyr::filter(`Perc.Ident` == max(`Perc.Ident`)) %>%
    as.data.frame()

proteins_symbols <-
    ensembldb::select(EnsDb.Mmusculus.v79, keys = grouped_predictions$`QueryID`,
                      keytype = "PROTEINID", columns = c("ENTREZID", "SYMBOL"))

merged_data <-
    merge(proteins_symbols, grouped_predictions,
          by.x = "PROTEINID", by.y = "QueryID") %>%
    dplyr::select(c("PROTEINID", "ENTREZID", "SYMBOL",
                    "SubjectID", "Perc.Ident"))

# Removing '.[1-9]' from accession numbers (if the step is skipped the
# following function 'bitr()' does not return any results):
merged_data$SubjectID <-
    merged_data$SubjectID %>%
    gsub("\\.[1-9]+", "", .)

# Accessing Entrez identification numbers and gene symbols for every
# accession number (some accession numbers do not have Entrez id, therefore
# they are not matched):
entrezs_symbols <-
    bitr(merged_data$SubjectID, fromType = "ACCNUM",
         toType = c("ENTREZID", "SYMBOL"), OrgDb = org.Hs.eg.db)

# Creating a final dataframe that matches all subject and query data:
matched_data <-
    merge(merged_data, entrezs_symbols, by.x = "SubjectID", by.y = "ACCNUM") %>%
    rename("QueryID" = "PROTEINID", "EntrezQuery" = "ENTREZID.x",
           "QuerySymbol" = "SYMBOL.x", "EntrezSubject" = "ENTREZID.y",
           "SubjectSymbol" = "SYMBOL.y", "PercentIdentity" = "Perc.Ident") %>%
    dplyr::select(c("SubjectID", "QueryID", "SubjectSymbol", "QuerySymbol",
                    "EntrezSubject", "EntrezQuery", "PercentIdentity"))

# nolint end
```

```{r}
# nolint start
matched_data <- matched_data[!(is.na(matched_data$EntrezQuery)), ]
hggene_ranges <- genes(txdb_hs)

mm_sequences <- character()
hg_sequences <- character()

for (id in 1:length(matched_data$EntrezQuery)) {
    seq_m <- getSeq(BSgenome.Mmusculus.UCSC.mm10,
                    mmgene_ranges[mmgene_ranges$gene_id ==
                                  matched_data$EntrezQuery[id], ])

    if (length(seq_m) == 0) { next }
    else {
        names(seq_m) <- matched_data[id, "QuerySymbol"]
        mm_sequences <- append(mm_sequences, seq_m)
    }

    seq_h <- getSeq(BSgenome.Hsapiens.UCSC.hg38,
                    hggene_ranges[hggene_ranges$gene_id ==
                                  matched_data$EntrezSubject[id], ])

    if (length(seq_h) == 0) { next }
    else {
        names(seq_h) <- matched_data[id, "SubjectSymbol"]
        hg_sequences <- append(hg_sequences, seq_h)
    }
}



countPWM(as.matrix(pwm), as.character(hg_sequences[[8]]), min.score = "60%")
# nolint end
```


```{r}
# nolint start
percentages <- data.frame(matrix(ncol = 5, nrow = 0))
colnames(percentages) <- c("QueryGene", "SubjectGene", "QueryPWMHits",
                           "SubjectPWMHits", "Percent")


for (gene in 1:length(mm_sequences)) {
    mm_hits <-
        as.numeric(countPWM(as.matrix(pwm), as.character(mm_sequences[[gene]]),
                            min.score = "60%"))

    hg_hits <-
        as.numeric(countPWM(as.matrix(pwm), as.character(hg_sequences[[gene]]),
                            min.score = "60%"))

    row <- c(names(mm_sequences[gene]), names(hg_sequences[gene]),
             mm_hits, hg_hits, (mm_hits / hg_hits) * 100)

    percentages[nrow(percentages) + 1, ] <- row            
}

percentages$SubjectGene %in% hg_annotated_peaks[[1]]$gene_symbol
# nolint end
```
